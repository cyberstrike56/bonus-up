<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Бонусная программа</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 max-w-md">
        <!-- Навигация -->
        <div class="text-center mb-4">
            <div class="flex justify-around">
                <button onclick="showClientInterface()" class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600">Клиент</button>
                <button onclick="showAdminLogin()" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600">Админ</button>
            </div>
        </div>

        <!-- Клиентский интерфейс -->
        <div id="clientInterface" class="hidden">
            <h1 class="text-2xl font-bold text-center mb-4">Клиентская программа</h1>
            <div id="loginForm" class="mb-4">
                <select id="inputType" class="w-full p-2 border rounded-lg mb-2 focus:outline-none">
                    <option value="email">Email</option>
                    <option value="phone">Номер телефона</option>
                </select>
                <input id="userInput" type="text" placeholder="Введите email или номер телефона" class="w-full p-2 border rounded-lg mb-2 focus:outline-none">
                <input id="firstNameInput" type="text" placeholder="Введите имя" class="w-full p-2 border rounded-lg mb-2 focus:outline-none hidden" data-registration-only>
                <input id="lastNameInput" type="text" placeholder="Введите фамилию" class="w-full p-2 border rounded-lg mb-2 focus:outline-none hidden" data-registration-only>
                <input id="birthDateInput" type="date" placeholder="Дата рождения" class="w-full p-2 border rounded-lg mb-2 focus:outline-none hidden" data-registration-only>
                <button onclick="registerUser()" class="w-full bg-blue-500 text-white p-2 rounded-lg mt-2 hover:bg-blue-600">Зарегистрироваться</button>
                <button onclick="loginUser()" class="w-full bg-gray-500 text-white p-2 rounded-lg mt-2 hover:bg-gray-600">Войти</button>
            </div>
            <div id="userInfo" class="hidden mb-4 p-4 bg-white rounded-lg shadow">
                <p id="welcomeMessage" class="text-center mb-2"></p>
                <p><strong>Имя:</strong> <span id="displayFirstName"></span></p>
                <p><strong>Фамилия:</strong> <span id="displayLastName"></span></p>
                <p><strong>Идентификатор:</strong> <span id="displayIdentifier"></span> (<span id="displayType"></span>)</p>
                <p><strong>Бонусы:</strong> <span id="displayPoints"></span></p>
            </div>
            <div id="qrCodeContainer" class="flex justify-center mt-4"></div>
            <p id="qrMessage" class="text-center mt-2"></p>
        </div>

        <!-- Админский интерфейс: Вход -->
        <div id="adminLogin" class="hidden">
            <h1 class="text-2xl font-bold text-center mb-4">Вход для администратора</h1>
            <div class="mb-4">
                <input id="adminPhoneInput" type="text" placeholder="Введите номер телефона" class="w-full p-2 border rounded-lg mb-2 focus:outline-none">
                <button onclick="adminLogin()" class="w-full bg-green-500 text-white p-2 rounded-lg mt-2 hover:bg-green-600">Войти</button>
            </div>
            <p id="adminLoginMessage" class="text-center mt-2"></p>
        </div>

        <!-- Админский интерфейс: Сканер -->
        <div id="adminScanner" class="hidden">
            <h1 class="text-2xl font-bold text-center mb-4">Сканер QR-кода</h1>
            <div class="mb-4 p-4 bg-white rounded-lg shadow">
                <p id="adminWelcomeMessage" class="text-center mb-2"></p>
                <p><strong>Администратор:</strong> <span id="adminPhone"></span></p>
                <p><strong>Начислено бонусов:</strong> <span id="adminPointsAdded">0</span></p>
                <p><strong>Списано бонусов:</strong> <span id="adminPointsDeducted">0</span></p>
            </div>
            <div class="flex justify-around mb-4">
                <select id="scanAction" class="w-full p-2 border rounded-lg focus:outline-none">
                    <option value="add">Начислить бонусы</option>
                    <option value="deduct">Списать бонусы</option>
                </select>
                <button onclick="showClientList()" class="bg-yellow-500 text-white p-2 rounded-lg hover:bg-yellow-600">Показать базу клиентов</button>
                <a href="https://wa.me/1234567890" target="_blank" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 text-center w-full">WhatsApp</a>
            </div>
            <div id="qrScanner" class="w-full h-64 bg-gray-200 rounded-lg"></div>
            <p id="scanResult" class="text-center mt-4"></p>
            <button onclick="startScanner()" class="w-full bg-green-500 text-white p-2 rounded-lg mt-2 hover:bg-green-600">Начать сканирование</button>
            <div id="clientList" class="hidden mt-4 p-4 bg-white rounded-lg shadow">
                <h2 class="text-xl font-bold mb-2">База клиентов</h2>
                <ul id="clientListItems"></ul>
            </div>
        </div>
    </div>

    <script>
        // Список шуток
        const jokes = [
            "Почему программист предпочитает темную тему? Потому что светлая жрёт батарейку!",
            "Что сказал один бесконечный цикл другому? 'Поговорим потом, я занят!'",
            "Почему скелет не использовал компьютер? Потому что у него не было guts (внутренностей и смелости)!",
            "Как зовут программиста, который не спит? JavaScript-маньяк!"
        ];

        // Получение случайной шутки
        function getRandomJoke() {
            const randomIndex = Math.floor(Math.random() * jokes.length);
            return jokes[randomIndex];
        }

        // Инициализация списка администраторов
        function initializeAdmins() {
            const admins = [
                { phone: '+71234567890', pointsAdded: 0, pointsDeducted: 0 },
                { phone: '+70987654321', pointsAdded: 0, pointsDeducted: 0 },
                { phone: '+79776632788', pointsAdded: 0, pointsDeducted: 0 },
                { phone: '+79878808777', pointsAdded: 0, pointsDeducted: 0 }
            ];
            if (!localStorage.getItem('admins')) {
                localStorage.setItem('admins', JSON.stringify(admins));
            }
        }

        // Проверка, является ли номер администраторским
        function isAdmin(phone) {
            const admins = JSON.parse(localStorage.getItem('admins')) || [];
            return admins.some(admin => admin.phone === phone);
        }

        // Обновление статистики администратора
        function updateAdminStats(phone, pointsAdded = 0, pointsDeducted = 0) {
            const admins = JSON.parse(localStorage.getItem('admins')) || [];
            const admin = admins.find(a => a.phone === phone);
            if (admin) {
                admin.pointsAdded += pointsAdded;
                admin.pointsDeducted += pointsDeducted;
                localStorage.setItem('admins', JSON.stringify(admins));
            }
            return admin;
        }

        // Генерация UUID для уникального ID пользователя
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Сохранение пользователя в localStorage с датой
        function saveUser(identifier, type, firstName, lastName, birthDate, userId, points = 0) {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const registrationDate = new Date().toLocaleString('ru-RU', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Europe/Berlin' });
            users.push({ identifier, type, firstName, lastName, birthDate, userId, points, registrationDate });
            localStorage.setItem('users', JSON.stringify(users));
        }

        // Обновление бонусов пользователя
        function updateUserPoints(userId, pointsChange, isAdd) {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const user = users.find(u => u.userId === userId);
            if (user) {
                if (isAdd) {
                    user.points = (user.points || 0) + pointsChange;
                } else {
                    if ((user.points || 0) < pointsChange) {
                        return null; // Недостаточно бонусов
                    }
                    user.points = (user.points || 0) - pointsChange;
                }
                localStorage.setItem('users', JSON.stringify(users));
            }
            return user;
        }

        // Поиск пользователя по идентификатору (email или phone)
        function findUserByIdentifier(identifier, type) {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            return users.find(user => user.identifier === identifier && user.type === type);
        }

        // Поиск пользователя по userId
        function findUserById(userId) {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            return users.find(user => user.userId === userId);
        }

        // Валидация email
        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        // Валидация номера телефона (для России: +7 или 8 и 10 цифр)
        function isValidPhone(phone) {
            return /^\+?7[0-9]{10}$|^8[0-9]{10}$/.test(phone);
        }

        // Валидация имени и фамилии
        function isValidName(name) {
            return name.trim().length > 0;
        }

        // Валидация даты рождения (старше 16 лет на 05.08.2025)
        function isValidBirthDate(birthDate) {
            const date = new Date(birthDate);
            const today = new Date('2025-08-05');
            const age = today.getFullYear() - date.getFullYear();
            const monthDiff = today.getMonth() - date.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < date.getDate())) {
                age--;
            }
            return !isNaN(date) && date <= today && age >= 16;
        }

        // Показать/скрыть поля регистрации
        function toggleRegistrationFields(show) {
            const fields = document.querySelectorAll('[data-registration-only]');
            fields.forEach(field => {
                field.classList.toggle('hidden', !show);
            });
        }

        // Отобразить информацию о пользователе
        function displayUserInfo(user) {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('displayFirstName').textContent = user.firstName;
            document.getElementById('displayLastName').textContent = user.lastName;
            document.getElementById('displayIdentifier').textContent = user.identifier;
            document.getElementById('displayType').textContent = user.type === 'email' ? 'Email' : 'Телефон';
            document.getElementById('displayPoints').textContent = user.points || 0;
            // Добавление приветствия и даты
            const welcomeMessage = document.getElementById('welcomeMessage');
            welcomeMessage.textContent = `Привет, ${user.firstName}! Сегодня среда, 06 августа 2025 года, 01:02 PM CEST.`;
        }

        // Регистрация пользователя
        function registerUser() {
            const inputType = document.getElementById('inputType').value;
            const userInput = document.getElementById('userInput').value.trim();
            const firstNameInput = document.getElementById('firstNameInput').value.trim();
            const lastNameInput = document.getElementById('lastNameInput').value.trim();
            const birthDateInput = document.getElementById('birthDateInput').value;
            const qrCodeContainer = document.getElementById('qrCodeContainer');
            const qrMessage = document.getElementById('qrMessage');

            // Показать поля регистрации
            toggleRegistrationFields(true);

            // Валидация
            if (inputType === 'email' && !isValidEmail(userInput)) {
                qrMessage.textContent = 'Пожалуйста, введите корректный email.';
                return;
            }
            if (inputType === 'phone' && !isValidPhone(userInput)) {
                qrMessage.textContent = 'Пожалуйста, введите корректный номер телефона (например, +71234567890 или 81234567890).';
                return;
            }
            if (!isValidName(firstNameInput)) {
                qrMessage.textContent = 'Пожалуйста, введите корректное имя.';
                return;
            }
            if (!isValidName(lastNameInput)) {
                qrMessage.textContent = 'Пожалуйста, введите корректную фамилию.';
                return;
            }
            if (!isValidBirthDate(birthDateInput)) {
                qrMessage.textContent = 'Пожалуйста, введите корректную дату рождения (возраст должен быть 16+).';
                return;
            }

            // Проверка, не зарегистрирован ли уже пользователь
            if (findUserByIdentifier(userInput, inputType)) {
                qrMessage.textContent = 'Этот ' + (inputType === 'email' ? 'email' : 'номер телефона') + ' уже зарегистрирован.';
                return;
            }

            const userId = generateUUID();
            saveUser(userInput, inputType, firstNameInput, lastNameInput, birthDateInput, userId);

            const user = findUserByIdentifier(userInput, inputType);
            qrCodeContainer.innerHTML = '';
            new QRCode(qrCodeContainer, {
                text: userId,
                width: 200,
                height: 200
            });

            qrMessage.textContent = 'Ваш QR-код для накопления бонусов готов!';
            displayUserInfo(user);
            document.getElementById('userInput').value = '';
            document.getElementById('firstNameInput').value = '';
            document.getElementById('lastNameInput').value = '';
            document.getElementById('birthDateInput').value = '';
            toggleRegistrationFields(false);
        }

        // Вход пользователя
        function loginUser() {
            const inputType = document.getElementById('inputType').value;
            const userInput = document.getElementById('userInput').value.trim();
            const qrCodeContainer = document.getElementById('qrCodeContainer');
            const qrMessage = document.getElementById('qrMessage');

            // Скрыть поля регистрации при входе
            toggleRegistrationFields(false);

            if (inputType === 'email' && !isValidEmail(userInput)) {
                qrMessage.textContent = 'Пожалуйста, введите корректный email.';
                return;
            }
            if (inputType === 'phone' && !isValidPhone(userInput)) {
                qrMessage.textContent = 'Пожалуйста, введите корректный номер телефона (например, +71234567890 или 81234567890).';
                return;
            }

            const user = findUserByIdentifier(userInput, inputType);
            if (!user) {
                qrMessage.textContent = 'Пользователь с таким ' + (inputType === 'email' ? 'email' : 'номер телефона') + ' не найден.';
                return;
            }

            qrCodeContainer.innerHTML = '';
            new QRCode(qrCodeContainer, {
                text: user.userId,
                width: 200,
                height: 200
            });

            qrMessage.textContent = 'Ваш QR-код восстановлен!';
            displayUserInfo(user);
            document.getElementById('userInput').value = '';
        }

        // Вход администратора
        function adminLogin() {
            const phoneInput = document.getElementById('adminPhoneInput').value.trim();
            const loginMessage = document.getElementById('adminLoginMessage');

            if (!isValidPhone(phoneInput)) {
                loginMessage.textContent = 'Пожалуйста, введите корректный номер телефона (например, +71234567890).';
                return;
            }

            if (!isAdmin(phoneInput)) {
                loginMessage.textContent = 'Доступ запрещен: номер телефона не зарегистрирован как администраторский.';
                return;
            }

            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('adminScanner').classList.remove('hidden');
            const admin = updateAdminStats(phoneInput); // Загрузить статистику
            document.getElementById('adminPhone').textContent = phoneInput;
            document.getElementById('adminPointsAdded').textContent = admin.pointsAdded || 0;
            document.getElementById('adminPointsDeducted').textContent = admin.pointsDeducted || 0;
            // Добавление приветствия, даты и шутки для +79878808777
            const adminWelcomeMessage = document.getElementById('adminWelcomeMessage');
            adminWelcomeMessage.textContent = `Привет, администратор! Сегодня среда, 06 августа 2025 года, 01:02 PM CEST.`;
            if (phoneInput === '+79878808777') {
                const joke = getRandomJoke();
                adminWelcomeMessage.textContent += ` А вот и шутка дня: ${joke}`;
            }
            loginMessage.textContent = '';
            document.getElementById('adminPhoneInput').value = '';
        }

        // Показать список клиентов
        function showClientList() {
            const clientList = document.getElementById('clientList');
            const clientListItems = document.getElementById('clientListItems');
            clientListItems.innerHTML = ''; // Очистка списка
            const users = JSON.parse(localStorage.getItem('users')) || [];
            if (users.length === 0) {
                clientListItems.innerHTML = '<li class="text-center">Нет зарегистрированных клиентов.</li>';
            } else {
                users.forEach(user => {
                    const li = document.createElement('li');
                    li.className = 'mb-2';
                    li.innerHTML = `<strong>${user.firstName} ${user.lastName}</strong> (ID: ${user.userId}, Тип: ${user.type === 'email' ? 'Email' : 'Телефон'}, Последняя регистрация: ${user.registrationDate})`;
                    clientListItems.appendChild(li);
                });
            }
            clientList.classList.remove('hidden');
        }

        // Показать клиентский интерфейс
        function showClientInterface() {
            document.getElementById('clientInterface').classList.remove('hidden');
            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('adminScanner').classList.add('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('qrCodeContainer').innerHTML = '';
            document.getElementById('qrMessage').textContent = '';
            stopScanner();
            toggleRegistrationFields(false);
        }

        // Показать экран входа администратора
        function showAdminLogin() {
            document.getElementById('clientInterface').classList.add('hidden');
            document.getElementById('adminLogin').classList.remove('hidden');
            document.getElementById('adminScanner').classList.add('hidden');
            document.getElementById('scanResult').textContent = '';
            stopScanner();
            document.getElementById('clientList').classList.add('hidden'); // Скрыть список при выходе
        }

        // Инициализация сканера
        let html5QrcodeScanner = null;
        function startScanner() {
            const scanResult = document.getElementById('scanResult');
            const scanAction = document.getElementById('scanAction').value;
            const adminPhone = document.getElementById('adminPhone').textContent;
            scanResult.textContent = 'Наведите камеру на QR-код...';
            html5QrcodeScanner = new Html5Qrcode('qrScanner');
            html5QrcodeScanner.start(
                { facingMode: 'environment' },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => {
                    const isAdd = scanAction === 'add';
                    const user = updateUserPoints(decodedText, 10, isAdd);
                    if (user) {
                        updateAdminStats(adminPhone, isAdd ? 10 : 0, isAdd ? 0 : 10);
                        document.getElementById('adminPointsAdded').textContent = (parseInt(document.getElementById('adminPointsAdded').textContent) || 0) + (isAdd ? 10 : 0);
                        document.getElementById('adminPointsDeducted').textContent = (parseInt(document.getElementById('adminPointsDeducted').textContent) || 0) + (isAdd ? 0 : 10);
                        scanResult.textContent = `Пользователь найден: ${user.firstName} ${user.lastName}, ${user.birthDate}, ${user.identifier} (${user.type === 'email' ? 'Email' : 'Телефон'}), Бонусы: ${user.points}`;
                    } else {
                        scanResult.textContent = isAdd ? 'QR-код недействителен.' : 'Недостаточно бонусов для списания.';
                    }
                    stopScanner();
                },
                (error) => {
                    // Игнорировать ошибки сканирования
                }
            ).catch((err) => {
                scanResult.textContent = 'Ошибка доступа к камере.';
            });
        }

        // Остановка сканера
        function stopScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner = null;
                }).catch(() => {});
            }
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            initializeAdmins();
            showClientInterface();
        });
    </script>
</body>
</html>