<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Бонусная программа</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link rel="manifest" href="/manifest.json">
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 max-w-md">
        <!-- Навигация -->
        <div class="text-center mb-4">
            <div class="flex justify-around">
                <button onclick="showClientInterface()" class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600">Клиент</button>
                <button onclick="showAdminLogin()" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600">Админ</button>
            </div>
            <p class="mt-2 text-lg text-gray-700">Приветствуем вас в партнерской программе Gamezone</p>
        </div>

        <!-- Клиентский интерфейс -->
        <div id="clientInterface" class="hidden">
            <h1 class="text-2xl font-bold text-center mb-4">Клиентская программа</h1>
            <div id="loginForm" class="mb-4">
                <input id="userInput" type="text" placeholder="Введите номер телефона (например, +71234567890 или 81234567890)" class="w-full p-2 border rounded-lg mb-2 focus:outline-none">
                <input id="firstNameInput" type="text" placeholder="Введите имя" class="w-full p-2 border rounded-lg mb-2 focus:outline-none hidden" data-registration-only>
                <input id="lastNameInput" type="text" placeholder="Введите фамилию" class="w-full p-2 border rounded-lg mb-2 focus:outline-none hidden" data-registration-only>
                <input id="birthDateInput" type="date" placeholder="Дата рождения" class="w-full p-2 border rounded-lg mb-2 focus:outline-none hidden" data-registration-only>
                <button id="startRegisterButton" onclick="startRegistration()" class="w-full bg-blue-500 text-white p-2 rounded-lg mt-2 hover:bg-blue-600">Зарегистрироваться</button>
                <button id="finishRegisterButton" onclick="registerUser()" class="w-full bg-blue-500 text-white p-2 rounded-lg mt-2 hover:bg-blue-600 hidden">Завершить регистрацию</button>
                <button onclick="loginUser()" class="w-full bg-gray-500 text-white p-2 rounded-lg mt-2 hover:bg-gray-600">Войти</button>
            </div>
            <div id="userInfo" class="hidden mb-4 p-4 bg-white rounded-lg shadow">
                <p id="welcomeMessage" class="text-center mb-2"></p>
                <p><strong>Имя:</strong> <span id="displayFirstName"></span></p>
                <p><strong>Фамилия:</strong> <span id="displayLastName"></span></p>
                <p><strong>Идентификатор:</strong> <span id="displayIdentifier"></span> (<span id="displayType">Телефон</span>)</p>
                <p><strong>Бонусы:</strong> <span id="displayPoints"></span></p>
                <button onclick="openReview()" class="w-full bg-green-500 text-white p-2 rounded-lg mt-4 hover:bg-green-600">Оставить отзыв</button>
            </div>
            <div id="qrCodeContainer" class="flex justify-center mt-4"></div>
            <p id="qrMessage" class="text-center mt-2"></p>
        </div>

        <!-- Админский интерфейс: Вход -->
        <div id="adminLogin" class="hidden">
            <h1 class="text-2xl font-bold text-center mb-4">Вход для администратора</h1>
            <div class="mb-4">
                <input id="adminPhoneInput" type="text" placeholder="Введите номер телефона (например, +71234567890 или 81234567890)" class="w-full p-2 border rounded-lg mb-2 focus:outline-none">
                <button onclick="adminLogin()" class="w-full bg-green-500 text-white p-2 rounded-lg mt-2 hover:bg-green-600">Войти</button>
            </div>
            <p id="adminLoginMessage" class="text-center mt-2"></p>
        </div>

        <!-- Админский интерфейс: Сканер и статистика -->
        <div id="adminScanner" class="hidden">
            <h1 class="text-2xl font-bold text-center mb-4">Сканер QR-кода</h1>
            <div class="mb-4 p-4 bg-white rounded-lg shadow">
                <p id="adminWelcomeMessage" class="text-center mb-2"></p>
                <p><strong>Администратор:</strong> <span id="adminPhone"></span></p>
                <p><strong>Начислено бонусов:</strong> <span id="adminPointsAdded">0</span></p>
                <p><strong>Списано бонусов:</strong> <span id="adminPointsDeducted">0</span></p>
            </div>
            <div class="flex justify-around mb-4 flex-wrap">
                <select id="scanAction" class="w-full p-2 border rounded-lg focus:outline-none mb-2">
                    <option value="add">Начислить бонусы</option>
                    <option value="deduct">Списать бонусы</option>
                </select>
                <button onclick="toggleClientList()" class="bg-yellow-500 text-white p-2 rounded-lg hover:bg-yellow-600 w-full mx-1 mb-2">Показать/скрыть базу клиентов</button>
                <a href="https://wa.me/1234567890" target="_blank" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 text-center w-full mx-1 mb-2">WhatsApp</a>
            </div>
            <div class="mb-2">
                <select id="cameraSelect" class="w-full p-2 border rounded-lg focus:outline-none">
                    <option value="environment">Задняя камера</option>
                    <option value="user">Фронтальная камера</option>
                </select>
            </div>
            <button onclick="toggleScanner()" class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 w-full mx-1 mb-2">Начать сканирование</button>
            <div id="qrScanner" class="w-full h-64 bg-gray-200 rounded-lg hidden"></div>
            <p id="scanResult" class="text-center mt-4"></p>
            <div id="clientList" class="hidden mt-4 p-4 bg-white rounded-lg shadow">
                <h2 class="text-xl font-bold mb-2">База клиентов</h2>
                <ul id="clientListItems"></ul>
            </div>
        </div>
    </div>

    <script>
        // Предотвращение закрытия страницы при нажатии "назад" или свайпе
        window.onpopstate = function(event) {
            location.reload();
        };

        // Открытие ссылки для отзыва
        function openReview() {
            window.open('https://yandex.ru/maps/org/game_zone/52624971299/reviews/?add-review=true&ll=55.266994%2C51.808670&mode=search&sll=55.252704%2C51.767575&sspn=0.175095%2C0.085099&tab=reviews&text=%D1%8F%D0%BD%D0%B4%D0%B5%D0%BA%D1%81%20gamezone%20%D0%BE%D1%80%D0%B5%D0%BD%D0%B1%D1%83%D1%80%D0%B3&z=12', '_blank');
        }

        // Инициализация списка администраторов
        function initializeAdmins() {
            const admins = [
                { phone: '+71234567890', pointsAdded: 0, pointsDeducted: 0 },
                { phone: '+70987654321', pointsAdded: 0, pointsDeducted: 0 },
                { phone: '+79776632788', pointsAdded: 0, pointsDeducted: 0 },
                { phone: '+79878808777', name: 'Валентина', pointsAdded: 0, pointsDeducted: 0 },
                { phone: '+79876632788', name: 'Дмитрий', pointsAdded: 0, pointsDeducted: 0 }
            ];
            const existingAdmins = localStorage.getItem('admins');
            if (!existingAdmins) {
                localStorage.setItem('admins', JSON.stringify(admins));
                console.log('Администраторы инициализированы:', admins);
            } else {
                const parsedAdmins = JSON.parse(existingAdmins);
                console.log('Существующие администраторы:', parsedAdmins);
                admins.forEach(admin => {
                    if (!parsedAdmins.some(a => a.phone === admin.phone)) {
                        parsedAdmins.push(admin);
                    }
                });
                localStorage.setItem('admins', JSON.stringify(parsedAdmins));
                console.log('Обновлённый список администраторов:', parsedAdmins);
            }
        }

        // Проверка, является ли номер администраторским
        function isAdmin(phone) {
            if (!phone) return false;
            const admins = JSON.parse(localStorage.getItem('admins')) || [];
            const normalizedInput = normalizePhone(phone);
            const normalizedAdmins = admins.map(admin => normalizePhone(admin.phone));
            const result = normalizedAdmins.includes(normalizedInput);
            console.log('Проверка isAdmin:', { phone, normalizedInput, normalizedAdmins, result });
            return result;
        }

        // Нормализация номера телефона
        function normalizePhone(phone) {
            if (!phone || typeof phone !== 'string') {
                console.warn('Некорректный номер телефона:', phone);
                return '';
            }
            let normalized = phone.replace(/[^\d]/g, '');
            if (normalized.length === 11) {
                if (normalized.startsWith('8')) {
                    return '+7' + normalized.slice(1);
                } else if (normalized.startsWith('7')) {
                    return '+' + normalized;
                }
            }
            return normalized.length === 11 ? '+' + normalized : normalized;
        }

        // Обновление статистики администратора
        function updateAdminStats(phone, pointsAdded = 0, pointsDeducted = 0) {
            if (!phone) return null;
            const admins = JSON.parse(localStorage.getItem('admins')) || [];
            const admin = admins.find(a => normalizePhone(a.phone) === normalizePhone(phone));
            if (admin) {
                admin.pointsAdded += pointsAdded;
                admin.pointsDeducted += pointsDeducted;
                localStorage.setItem('admins', JSON.stringify(admins));
                console.log('Статистика администратора обновлена:', admin);
            }
            return admin;
        }

        // Генерация UUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Сохранение пользователя
        function saveUser(identifier, type, firstName, lastName, birthDate, userId, points = 0) {
            if (!identifier) return;
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const registrationDate = new Date().toLocaleString('ru-RU', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false });
            users.push({ identifier, type, firstName, lastName, birthDate, userId, points, registrationDate });
            localStorage.setItem('users', JSON.stringify(users));
            console.log('Пользователь сохранён:', { identifier, userId });
        }

        // Обновление бонусов
        function updateUserPoints(userId, pointsChange, isAdd) {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const user = users.find(u => u.userId === userId);
            if (user) {
                if (isAdd) {
                    user.points = (user.points || 0) + pointsChange;
                } else {
                    if ((user.points || 0) < pointsChange) return null;
                    user.points -= pointsChange;
                }
                localStorage.setItem('users', JSON.stringify(users));
                console.log('Бонусы обновлены:', { userId, points: user.points });
            }
            return user;
        }

        // Поиск пользователя по идентификатору
        function findUserByIdentifier(identifier, type) {
            if (!identifier) return null;
            const users = JSON.parse(localStorage.getItem('users')) || [];
            return users.find(user => normalizePhone(user.identifier) === normalizePhone(identifier) && user.type === type);
        }

        // Поиск пользователя по userId
        function findUserById(userId) {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            return users.find(user => user.userId === userId);
        }

        // Валидация номера телефона
        function isValidPhone(phone) {
            if (!phone || typeof phone !== 'string') {
                console.warn('Некорректный ввод номера телефона:', phone);
                return false;
            }
            const normalized = normalizePhone(phone);
            const isValid = (/^(\+7|8)[0-9]{10}$/.test(normalized) && normalized.length === 11) || normalized.startsWith('+7');
            console.log('Валидация телефона:', { phone, normalized, isValid });
            return isValid;
        }

        // Валидация имени
        function isValidName(name) {
            return name && name.trim().length > 0;
        }

        // Валидация даты рождения
        function isValidBirthDate(birthDate) {
            const date = new Date(birthDate);
            const today = new Date('2025-08-28');
            const age = today.getFullYear() - date.getFullYear();
            const monthDiff = today.getMonth() - date.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < date.getDate())) age--;
            return !isNaN(date) && date <= today && age >= 14;
        }

        // Показать/скрыть поля регистрации
        function toggleRegistrationFields(show) {
            const fields = document.querySelectorAll('[data-registration-only]');
            fields.forEach(field => field.classList.toggle('hidden', !show));
            document.getElementById('startRegisterButton').classList.toggle('hidden', show);
            document.getElementById('finishRegisterButton').classList.toggle('hidden', !show);
        }

        // Старт процесса регистрации
        function startRegistration() {
            const userInput = document.getElementById('userInput').value.trim();
            const qrMessage = document.getElementById('qrMessage');

            if (!userInput) {
                qrMessage.textContent = 'Пожалуйста, введите номер телефона.';
                return;
            }

            if (!isValidPhone(userInput)) {
                qrMessage.textContent = 'Пожалуйста, введите корректный номер телефона (например, +71234567890 или 81234567890).';
                return;
            }

            if (findUserByIdentifier(userInput, 'phone')) {
                qrMessage.textContent = 'Этот номер телефона уже зарегистрирован.';
                return;
            }

            toggleRegistrationFields(true);
            qrMessage.textContent = 'Введите имя, фамилию и дату рождения для завершения регистрации.';
        }

        // Завершение регистрации
        function registerUser() {
            const userInput = document.getElementById('userInput').value.trim();
            const firstNameInput = document.getElementById('firstNameInput').value.trim();
            const lastNameInput = document.getElementById('lastNameInput').value.trim();
            const birthDateInput = document.getElementById('birthDateInput').value;
            const qrCodeContainer = document.getElementById('qrCodeContainer');
            const qrMessage = document.getElementById('qrMessage');

            if (!userInput || !firstNameInput || !lastNameInput || !birthDateInput) {
                qrMessage.textContent = 'Пожалуйста, заполните все поля.';
                return;
            }

            if (!isValidPhone(userInput)) {
                qrMessage.textContent = 'Пожалуйста, введите корректный номер телефона (например, +71234567890 или 81234567890).';
                return;
            }
            if (!isValidName(firstNameInput)) {
                qrMessage.textContent = 'Пожалуйста, введите корректное имя.';
                return;
            }
            if (!isValidName(lastNameInput)) {
                qrMessage.textContent = 'Пожалуйста, введите корректную фамилию.';
                return;
            }
            if (!isValidBirthDate(birthDateInput)) {
                qrMessage.textContent = 'Пожалуйста, введите корректную дату рождения (возраст должен быть 14+).';
                return;
            }

            const userId = generateUUID();
            saveUser(userInput, 'phone', firstNameInput, lastNameInput, birthDateInput, userId);

            const user = findUserByIdentifier(userInput, 'phone');
            qrCodeContainer.innerHTML = '';
            new QRCode(qrCodeContainer, { text: userId, width: 200, height: 200 });

            qrMessage.textContent = 'Ваш QR-код для накопления бонусов готов!';
            displayUserInfo(user);
            document.getElementById('userInput').value = '';
            document.getElementById('firstNameInput').value = '';
            document.getElementById('lastNameInput').value = '';
            document.getElementById('birthDateInput').value = '';
            toggleRegistrationFields(false);
        }

        // Отобразить информацию о пользователе
        function displayUserInfo(user) {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('displayFirstName').textContent = user.firstName;
            document.getElementById('displayLastName').textContent = user.lastName;
            document.getElementById('displayIdentifier').textContent = user.identifier;
            document.getElementById('displayType').textContent = 'Телефон';
            document.getElementById('displayPoints').textContent = user.points || 0;
            const welcomeMessage = document.getElementById('welcomeMessage');
            welcomeMessage.textContent = `Привет, ${user.firstName}!`;
        }

        // Вход пользователя
        function loginUser() {
            const userInput = document.getElementById('userInput').value.trim();
            const qrCodeContainer = document.getElementById('qrCodeContainer');
            const qrMessage = document.getElementById('qrMessage');

            if (!userInput) {
                qrMessage.textContent = 'Пожалуйста, введите номер телефона.';
                return;
            }

            toggleRegistrationFields(false);

            if (!isValidPhone(userInput)) {
                qrMessage.textContent = 'Пожалуйста, введите корректный номер телефона (например, +71234567890 или 81234567890).';
                return;
            }

            const user = findUserByIdentifier(userInput, 'phone');
            if (!user) {
                qrMessage.textContent = 'Пользователь с таким номером телефона не найден.';
                return;
            }

            qrCodeContainer.innerHTML = '';
            new QRCode(qrCodeContainer, { text: user.userId, width: 200, height: 200 });

            qrMessage.textContent = 'Ваш QR-код восстановлен!';
            displayUserInfo(user);
            document.getElementById('userInput').value = '';
        }

        // Вход администратора
        function adminLogin() {
            const phoneInput = document.getElementById('adminPhoneInput').value.trim();
            const loginMessage = document.getElementById('adminLoginMessage');

            if (!phoneInput) {
                loginMessage.textContent = 'Пожалуйста, введите номер телефона.';
                return;
            }

            if (!isValidPhone(phoneInput)) {
                loginMessage.textContent = 'Пожалуйста, введите корректный номер телефона (например, +71234567890 или 81234567890).';
                return;
            }

            if (!isAdmin(phoneInput)) {
                loginMessage.textContent = 'Доступ запрещен: номер телефона не зарегистрирован как администраторский. Проверьте формат (+79878808777).';
                return;
            }

            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('adminScanner').classList.remove('hidden');
            const admin = updateAdminStats(phoneInput);
            document.getElementById('adminPhone').textContent = phoneInput;
            document.getElementById('adminPointsAdded').textContent = admin.pointsAdded || 0;
            document.getElementById('adminPointsDeducted').textContent = admin.pointsDeducted || 0;
            const adminWelcomeMessage = document.getElementById('adminWelcomeMessage');
            adminWelcomeMessage.textContent = `Привет, администратор!`;
            loginMessage.textContent = '';
            document.getElementById('adminPhoneInput').value = '';
        }

        // Показать/скрыть список клиентов
        function toggleClientList() {
            const clientList = document.getElementById('clientList');
            clientList.classList.toggle('hidden');
            if (!clientList.classList.contains('hidden')) {
                showClientList();
            }
        }

        // Отобразить список клиентов
        function showClientList() {
            const clientListItems = document.getElementById('clientListItems');
            clientListItems.innerHTML = '';
            const users = JSON.parse(localStorage.getItem('users')) || [];
            if (users.length === 0) {
                clientListItems.innerHTML = '<li class="text-center">Нет зарегистрированных клиентов.</li>';
            } else {
                users.forEach(user => {
                    const li = document.createElement('li');
                    li.className = 'mb-2';
                    const birthDate = new Date(user.birthDate);
                    const today = new Date('2025-08-28');
                    const isBirthday = birthDate.getMonth() === today.getMonth() && birthDate.getDate() === today.getDate();
                    const birthdayText = isBirthday ? ' (Сегодня день рождения!)' : '';
                    const normalizedPhone = normalizePhone(user.identifier);
                    li.innerHTML = `<strong>${user.firstName} ${user.lastName}</strong> (ID: ${user.userId}, Телефон: ${normalizedPhone}, Дата рождения: ${birthDate.toLocaleDateString('ru-RU')}${birthdayText})`;
                    if (isBirthday) {
                        const encodedText = encodeURIComponent('Здравствуйте! Поздравляем вас с днём рождения! Желаем всего самого что бы вы сами себе пожелали умноженное на миллион, начислим вам 500 бонусов при посещении нашего парка ;) Отличного дня!');
                        const whatsappLink = `https://wa.me/${normalizedPhone.replace('+', '')}?text=${encodedText}`;
                        const telegramLink = `https://api.whatsapp.com/send?phone=${normalizedPhone}&text=${encodedText}`;
                        li.innerHTML += ` <a href="${whatsappLink}" target="_blank" class="text-green-500 ml-2">WhatsApp</a>`;
                        li.innerHTML += ` <a href="${telegramLink}" target="_blank" class="text-blue-500 ml-2">Telegram</a>`;
                    }
                    clientListItems.appendChild(li);
                });
            }
        }

        // Показать клиентский интерфейс
        function showClientInterface() {
            document.getElementById('clientInterface').classList.remove('hidden');
            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('adminScanner').classList.add('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('qrCodeContainer').innerHTML = '';
            document.getElementById('qrMessage').textContent = '';
            stopScanner();
            toggleRegistrationFields(false);
        }

        // Показать экран входа администратора
        function showAdminLogin() {
            document.getElementById('clientInterface').classList.add('hidden');
            document.getElementById('adminLogin').classList.remove('hidden');
            document.getElementById('adminScanner').classList.add('hidden');
            document.getElementById('scanResult').textContent = '';
            stopScanner();
            document.getElementById('clientList').classList.add('hidden');
            document.getElementById('qrScanner').classList.add('hidden');
        }

        // Переключение сканера
        function toggleScanner() {
            const scanner = document.getElementById('qrScanner');
            const isHidden = scanner.classList.contains('hidden');
            scanner.classList.toggle('hidden', !isHidden);
            if (isHidden) startScanner(); else stopScanner();
            document.getElementById('scanResult').textContent = '';
        }

        // Инициализация сканера
        let html5QrcodeScanner = null;
        function startScanner() {
            const scanResult = document.getElementById('scanResult');
            const scanAction = document.getElementById('scanAction').value;
            const adminPhone = document.getElementById('adminPhone')?.textContent;
            const cameraSelect = document.getElementById('cameraSelect').value;
            if (!adminPhone) {
                scanResult.textContent = 'Ошибка: администратор не определён.';
                return;
            }
            scanResult.textContent = 'Наведите камеру на QR-код...';
            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    let selectedCamera = devices.find(device => device.facingMode === cameraSelect) || devices[0];
                    if (!selectedCamera) {
                        selectedCamera = devices[0]; // Фallback на первую камеру, если нужная не найдена
                        console.warn('Выбранная камера не найдена, используется первая доступная:', selectedCamera);
                    }
                    html5QrcodeScanner = new Html5Qrcode("qrScanner");
                    html5QrcodeScanner.start(
                        selectedCamera.id,
                        { 
                            fps: 10, 
                            qrbox: { width: 250, height: 250 },
                            facingMode: cameraSelect
                        },
                        (decodedText) => {
                            const isAdd = scanAction === 'add';
                            const user = updateUserPoints(decodedText, 10, isAdd);
                            if (user) {
                                updateAdminStats(adminPhone, isAdd ? 10 : 0, isAdd ? 0 : 10);
                                document.getElementById('adminPointsAdded').textContent = (parseInt(document.getElementById('adminPointsAdded').textContent) || 0) + (isAdd ? 10 : 0);
                                document.getElementById('adminPointsDeducted').textContent = (parseInt(document.getElementById('adminPointsDeducted').textContent) || 0) + (isAdd ? 0 : 10);
                                scanResult.textContent = `Сканирование завершено. ${isAdd ? 'Начислено' : 'Списано'} 10 бонусов.`;
                            } else {
                                scanResult.textContent = 'Ошибка: недостаточно бонусов для списания.';
                            }
                            stopScanner();
                        },
                        (error) => {
                            scanResult.textContent = 'Ошибка сканирования: ' + error;
                        }
                    ).catch(err => {
                        scanResult.textContent = 'Ошибка инициализации сканера: ' + err;
                    });
                } else {
                    scanResult.textContent = 'Ошибка: Камера не обнаружена. Убедитесь, что доступ к камере разрешён.';
                }
            }).catch(err => {
                scanResult.textContent = 'Ошибка: Не удалось получить список камер. Проверьте разрешения.';
            });
        }

        // Остановка сканера
        function stopScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    html5QrcodeScanner = null;
                }).catch(err => console.error('Ошибка остановки сканера:', err));
            }
        }

        // Инициализация при загрузке
        window.onload = initializeAdmins;
    </script>